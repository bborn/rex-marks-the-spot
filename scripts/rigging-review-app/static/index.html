<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rigging Review</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #1a1a2e; color: #eee; padding: 20px; }
        h1 { color: #e94560; margin-bottom: 10px; }
        h2 { color: #0f3460; background: #e94560; display: inline-block; padding: 4px 12px; border-radius: 4px; margin: 16px 0 8px; font-size: 1.1em; }
        h3 { color: #aaa; margin: 8px 0; }

        .container { max-width: 1400px; margin: 0 auto; }

        /* Dashboard */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin: 16px 0; }
        .char-card { background: #16213e; border-radius: 8px; padding: 16px; border: 1px solid #0f3460; cursor: pointer; transition: border-color 0.2s; }
        .char-card:hover { border-color: #e94560; }
        .char-card .name { font-size: 1.2em; font-weight: bold; }
        .char-card .version { color: #aaa; font-size: 0.9em; }
        .char-card .status-bar { display: flex; gap: 8px; margin-top: 8px; }
        .badge { padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
        .badge.pending { background: #f0a500; color: #000; }
        .badge.approved { background: #2ecc71; color: #000; }
        .badge.rejected { background: #e74c3c; color: #fff; }

        /* Pose grid */
        .poses { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin: 16px 0; }
        .pose-card { background: #16213e; border-radius: 8px; overflow: hidden; border: 2px solid transparent; }
        .pose-card.status-approved { border-color: #2ecc71; }
        .pose-card.status-rejected { border-color: #e74c3c; }
        .pose-card.status-pending { border-color: #f0a500; }
        .pose-card img { width: 100%; height: 300px; object-fit: contain; background: #0a0a1a; }
        .pose-info { padding: 12px; }
        .pose-name { font-weight: bold; font-size: 1.1em; }
        .pose-status { margin: 6px 0; }
        .actions { display: flex; gap: 8px; margin: 8px 0; }
        .actions button { padding: 6px 14px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.9em; }
        .btn-approve { background: #2ecc71; color: #000; }
        .btn-reject { background: #e74c3c; color: #fff; }
        .btn-pending { background: #f0a500; color: #000; }
        .btn-approve:hover { background: #27ae60; }
        .btn-reject:hover { background: #c0392b; }

        /* Feedback */
        .feedback-list { margin: 8px 0; max-height: 120px; overflow-y: auto; }
        .feedback-item { background: #0a0a1a; padding: 6px 8px; margin: 4px 0; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #e94560; }
        .feedback-time { color: #666; font-size: 0.75em; }
        .feedback-form { display: flex; gap: 6px; margin-top: 8px; }
        .feedback-form input { flex: 1; padding: 6px 10px; border: 1px solid #0f3460; border-radius: 4px; background: #0a0a1a; color: #eee; font-size: 0.9em; }
        .feedback-form button { padding: 6px 12px; background: #0f3460; color: #eee; border: none; border-radius: 4px; cursor: pointer; }

        /* Navigation */
        .breadcrumb { color: #aaa; margin: 10px 0; font-size: 0.9em; }
        .breadcrumb a { color: #e94560; text-decoration: none; }
        .breadcrumb a:hover { text-decoration: underline; }

        /* New character form */
        .add-form { display: flex; gap: 8px; margin: 12px 0; align-items: center; }
        .add-form input, .add-form select { padding: 8px 12px; border: 1px solid #0f3460; border-radius: 4px; background: #16213e; color: #eee; }
        .add-form button { padding: 8px 16px; background: #e94560; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* Iteration selector */
        .iter-selector { margin: 12px 0; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .iter-btn { padding: 6px 14px; border: 1px solid #0f3460; border-radius: 4px; background: #16213e; color: #eee; cursor: pointer; }
        .iter-btn.active { background: #e94560; border-color: #e94560; }

        .subtitle { color: #888; font-size: 0.9em; margin-bottom: 16px; }
        .empty { color: #666; text-align: center; padding: 40px; font-style: italic; }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .api-hint { font-size: 0.75em; color: #666; background: #0a0a1a; padding: 4px 8px; border-radius: 4px; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div>
            <h1>Rigging Review</h1>
            <p class="subtitle">Human-in-the-loop quality gate for character rigging</p>
        </div>
        <span class="api-hint">API: POST /api/bulk-upload</span>
    </header>

    <div id="app"></div>
</div>

<script>
const API = '';

// State
let currentView = 'dashboard';  // dashboard | character
let currentChar = null;
let currentIteration = null;

// ---------------------------------------------------------------------------
// API helpers
// ---------------------------------------------------------------------------
async function api(path, opts) {
    const res = await fetch(API + path, opts);
    if (!res.ok) throw new Error(await res.text());
    return res.json();
}

// ---------------------------------------------------------------------------
// Dashboard view
// ---------------------------------------------------------------------------
async function renderDashboard() {
    const summary = await api('/api/summary');
    const chars = await api('/api/characters');

    let html = `
        <div class="add-form">
            <input id="new-char-name" placeholder="Character name (e.g. Mia)" />
            <button onclick="addCharacter()">+ Add Character</button>
        </div>
    `;

    if (chars.length === 0) {
        html += '<p class="empty">No characters yet. Add one above or use the bulk upload API.</p>';
    } else {
        html += '<div class="dashboard">';
        for (const s of summary) {
            const c = s.character;
            const ps = s.pose_status;
            const total = (ps.pending || 0) + (ps.approved || 0) + (ps.rejected || 0);
            html += `
                <div class="char-card" onclick="viewCharacter('${c.id}', '${c.name}')">
                    <div class="name">${c.name}</div>
                    <div class="version">Version ${s.latest_version || '—'} ${total > 0 ? '· ' + total + ' poses' : ''}</div>
                    <div class="status-bar">
                        ${ps.approved ? `<span class="badge approved">${ps.approved} approved</span>` : ''}
                        ${ps.rejected ? `<span class="badge rejected">${ps.rejected} rejected</span>` : ''}
                        ${ps.pending ? `<span class="badge pending">${ps.pending} pending</span>` : ''}
                        ${total === 0 ? '<span style="color:#666">No poses yet</span>' : ''}
                    </div>
                </div>
            `;
        }
        html += '</div>';
    }

    document.getElementById('app').innerHTML = html;
    currentView = 'dashboard';
}

async function addCharacter() {
    const name = document.getElementById('new-char-name').value.trim();
    if (!name) return;
    const fd = new FormData();
    fd.append('name', name);
    await api('/api/characters', { method: 'POST', body: fd });
    renderDashboard();
}

// ---------------------------------------------------------------------------
// Character view (iterations + poses)
// ---------------------------------------------------------------------------
async function viewCharacter(charId, charName) {
    currentChar = { id: charId, name: charName };
    const iterations = await api(`/api/characters/${charId}/iterations`);

    let html = `
        <div class="breadcrumb"><a href="#" onclick="renderDashboard(); return false;">Dashboard</a> / ${charName}</div>
        <h2>${charName}</h2>
    `;

    if (iterations.length === 0) {
        html += '<p class="empty">No iterations yet. Upload stress test renders via the API.</p>';
        html += renderNewIterationForm(charId);
    } else {
        // Iteration tabs
        const latest = currentIteration && iterations.find(i => i.id === currentIteration)
            ? currentIteration : iterations[iterations.length - 1].id;
        currentIteration = latest;

        html += '<div class="iter-selector">';
        html += '<span style="color:#aaa">Iterations:</span>';
        for (const it of iterations) {
            const active = it.id === latest ? 'active' : '';
            html += `<button class="iter-btn ${active}" onclick="selectIteration('${charId}', '${charName}', '${it.id}')">
                v${it.version}${it.rigging_tool ? ' (' + it.rigging_tool + ')' : ''}
            </button>`;
        }
        html += '</div>';

        // Show selected iteration's notes
        const selIter = iterations.find(i => i.id === latest);
        if (selIter && selIter.notes) {
            html += `<h3>Notes: ${selIter.notes}</h3>`;
        }

        // Poses for selected iteration
        const poses = await api(`/api/iterations/${latest}/poses`);
        if (poses.length === 0) {
            html += '<p class="empty">No poses uploaded for this iteration yet.</p>';
        } else {
            html += '<div class="poses">';
            for (const p of poses) {
                html += renderPoseCard(p);
            }
            html += '</div>';
        }

        html += renderNewIterationForm(charId);
    }

    document.getElementById('app').innerHTML = html;
    currentView = 'character';
}

function renderNewIterationForm(charId) {
    return `
        <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #0f3460;">
            <h3>New Iteration</h3>
            <div class="add-form">
                <input id="iter-tool" placeholder="Rigging tool (e.g. Auto-Rig Pro)" />
                <input id="iter-notes" placeholder="Notes (e.g. fixed hip weights)" style="flex:2" />
                <button onclick="addIteration('${charId}')">+ New Iteration</button>
            </div>
        </div>
    `;
}

async function addIteration(charId) {
    const fd = new FormData();
    fd.append('rigging_tool', document.getElementById('iter-tool').value);
    fd.append('notes', document.getElementById('iter-notes').value);
    await api(`/api/characters/${charId}/iterations`, { method: 'POST', body: fd });
    viewCharacter(currentChar.id, currentChar.name);
}

function selectIteration(charId, charName, iterId) {
    currentIteration = iterId;
    viewCharacter(charId, charName);
}

// ---------------------------------------------------------------------------
// Pose card
// ---------------------------------------------------------------------------
function renderPoseCard(p) {
    const statusClass = `status-${p.status}`;
    let fbHtml = '';
    if (p.feedback && p.feedback.length > 0) {
        fbHtml = '<div class="feedback-list">';
        for (const f of p.feedback) {
            const time = new Date(f.created_at * 1000).toLocaleString();
            fbHtml += `<div class="feedback-item">${f.comment} <span class="feedback-time">${time}</span></div>`;
        }
        fbHtml += '</div>';
    }

    return `
        <div class="pose-card ${statusClass}">
            <img src="/uploads/${p.image_path}" alt="${p.pose_name}" loading="lazy" />
            <div class="pose-info">
                <div class="pose-name">${p.pose_name}</div>
                <div class="pose-status">
                    <span class="badge ${p.status}">${p.status}</span>
                </div>
                <div class="actions">
                    <button class="btn-approve" onclick="setStatus('${p.id}', 'approved')">Approve</button>
                    <button class="btn-reject" onclick="setStatus('${p.id}', 'rejected')">Reject</button>
                    <button class="btn-pending" onclick="setStatus('${p.id}', 'pending')">Reset</button>
                </div>
                ${fbHtml}
                <div class="feedback-form">
                    <input id="fb-${p.id}" placeholder="Add feedback (e.g. hair stretches sideways)" onkeydown="if(event.key==='Enter')addFeedback('${p.id}')" />
                    <button onclick="addFeedback('${p.id}')">Send</button>
                </div>
            </div>
        </div>
    `;
}

async function setStatus(poseId, status) {
    const fd = new FormData();
    fd.append('status', status);
    await api(`/api/poses/${poseId}/status`, { method: 'PUT', body: fd });
    viewCharacter(currentChar.id, currentChar.name);
}

async function addFeedback(poseId) {
    const input = document.getElementById(`fb-${poseId}`);
    const comment = input.value.trim();
    if (!comment) return;
    const fd = new FormData();
    fd.append('comment', comment);
    await api(`/api/poses/${poseId}/feedback`, { method: 'POST', body: fd });
    input.value = '';
    viewCharacter(currentChar.id, currentChar.name);
}

// ---------------------------------------------------------------------------
// Init
// ---------------------------------------------------------------------------
renderDashboard();
</script>
</body>
</html>
